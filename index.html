<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitFlow SaaS | Performance Tracker</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDpESLRjh9DKUiP5pKArLndHdKCzkozUKk", 
            authDomain: "fitflow-a1f9f.firebaseapp.com",
            projectId: "fitflow-a1f9f",
            storageBucket: "fitflow-a1f9f.appspot.com",
            messagingSenderId: "297014251479",
            appId: "1:297014251479:web:MTMxOWNhMDAtNzAwMC00MThiLWE40WUtYTkxNjY4MWM3",
            measurementId: "G-ZFDPO9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isLoginMode = false;

        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? "WELCOME BACK" : "CREATE ACCOUNT";
            document.getElementById('name-container').classList.toggle('hidden', isLoginMode);
            document.getElementById('auth-btn').innerText = isLoginMode ? "Login" : "Join Team";
            document.getElementById('toggle-text').innerText = isLoginMode ? "Need an account? Sign Up" : "Already a member? Login";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-pass').value;
            const name = document.getElementById('user-name').value;
            if(!email || !pass) return alert("Enter email and password");
            try {
                if (isLoginMode) { await signInWithEmailAndPassword(auth, email, pass); } 
                else {
                    if(!name) return alert("Enter full name");
                    const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", userCred.user.uid), { fullName: name, email: email, startingStats: {}, latestStats: {}, photos: {} });
                }
            } catch (error) { alert("Error: " + error.message); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                fetchUserData(user.uid);
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        async function fetchUserData(uid) {
            const docSnap = await getDoc(doc(db, "users", uid));
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('display-name').innerText = "Member: " + (data.fullName || "User");
                renderTracker(data.startingStats || {}, data.latestStats || {});
                loadPhotos(data.photos || {});
            }
        }

        window.logout = () => signOut(auth).then(() => location.reload());

        window.updateStats = async () => {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();
            
            let starting = data.startingStats || {};
            let latest = data.latestStats || {};

            ['weight', 'height', 'chest', 'waist', 'arm', 'uleg', 'lleg'].forEach(key => {
                const val = document.getElementById(`inp-${key}`)?.value;
                if(val && val > 0) {
                    const numVal = parseFloat(val);
                    latest[key] = numVal;
                    if(!starting[key]) starting[key] = numVal;
                    document.getElementById(`inp-${key}`).value = ""; // Clear
                } else if (key === 'height' && starting.height) {
                    latest.height = starting.height;
                }
            });

            await updateDoc(docRef, { startingStats: starting, latestStats: latest });
            fetchUserData(user.uid); // Refresh the UI
            alert("Progress Synced to Cloud!");
        };

        window.uploadPhoto = async (input, type) => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onloadend = async () => {
                const user = auth.currentUser;
                const photoData = {}; 
                photoData[`photos.${type}`] = reader.result;
                await updateDoc(doc(db, "users", user.uid), photoData);
                document.getElementById(`${type}-img`).src = reader.result;
                document.getElementById(`${type}-img`).classList.remove('hidden');
                document.getElementById(`${type}-placeholder`).classList.add('hidden');
            };
            if (file) reader.readAsDataURL(file);
        };
    </script>

    <style>
        .gradient-brand { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .hidden { display: none; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 1rem; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        #auth-overlay { backdrop-filter: blur(8px); }
        .photo-slot { aspect-ratio: 3/4; background: #f3f4f6; border: 2px dashed #d1d5db; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; border-radius: 1rem; cursor: pointer; }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .muscle-logo { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .profile-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
    </style>
</head>
<body class="bg-gray-50 font-sans pb-20 text-gray-900">

    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-blue-900/95 flex items-center justify-center p-4 text-center">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl border-t-8 border-blue-600">
            <h1 class="text-4xl font-black italic text-blue-900 mb-2 tracking-tighter">FITFLOW</h1>
            <h2 id="auth-title" class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-8">Create Account</h2>
            <div class="space-y-4 text-left text-gray-900">
                <div id="name-container"><label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Full Name</label>
                <input type="text" id="user-name" class="w-full p-4 bg-gray-100 rounded-xl outline-none" placeholder="Garry Newbery"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Email</label>
                <input type="email" id="user-email" class="w-full p-4 bg-gray-100 rounded-xl outline-none" placeholder="coach@example.com"></div>
                <div><label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Password</label>
                <input type="password" id="user-pass" class="w-full p-4 bg-gray-100 rounded-xl outline-none" placeholder="••••••••"></div>
                <button id="auth-btn" onclick="handleAuth()" class="w-full gradient-brand text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest mt-4">Join Team</button>
                <p id="toggle-text" onclick="toggleAuthMode()" class="text-center text-xs text-blue-600 font-bold mt-6 cursor-pointer underline">Login instead</p>
            </div>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <nav class="gradient-brand text-white p-4 shadow-lg sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center text-white">
                <h1 class="text-2xl font-bold tracking-tight italic">FITFLOW</h1>
                <div class="flex items-center gap-4">
                    <span id="display-name" class="hidden md:block text-xs font-bold uppercase tracking-widest"></span>
                    <img src="coach.png" class="profile-avatar shadow-sm" alt="Coach">
                    <button onclick="logout()" class="text-white opacity-70"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </nav>

        <main class="container mx-auto p-4 md:p-8 space-y-8">
            <div id="dashboard-section" class="space-y-8">
                
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-4 border-l-8 border-blue-600">
                    <img src="coach.png" class="w-20 h-20 rounded-2xl object-cover shadow-lg" alt="Coach">
                    <div><h2 class="text-sm font-black text-gray-400 uppercase tracking-widest text-blue-600">Performance Coach</h2><p class="text-xl font-bold italic text-blue-900 leading-tight">Coach Garry Newbery</p></div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="text-sm font-black text-gray-800 uppercase italic tracking-widest">Live Progress Table</h2><span id="bmi-badge" class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-1 rounded">BMI: --</span></div>
                    <div class="overflow-x-auto"><table class="w-full text-left text-xs"><thead><tr class="text-gray-400 uppercase border-b"><th class="pb-3">Area</th><th class="pb-3">Start</th><th class="pb-3">Latest</th><th class="pb-3 text-right">Change</th></tr></thead><tbody id="progress-table-body"></tbody></table></div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                    <h2 class="text-sm font-black text-gray-800 uppercase italic mb-4 text-center">Body Visuals Vault</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="document.getElementById('before-input').click()"><p class="text-[10px] font-bold text-gray-400 uppercase text-center mb-1">Before</p><div class="photo-slot"><img id="before-img" class="hidden"><span id="before-placeholder"><i class="fas fa-camera text-gray-300 text-xl"></i></span></div><input type="file" id="before-input" class="hidden" accept="image/*" onchange="uploadPhoto(this, 'before')"></div>
                        <div onclick="document.getElementById('after-input').click()"><p class="text-[10px] font-bold text-gray-400 uppercase text-center mb-1">Current</p><div class="photo-slot"><img id="after-img" class="hidden"><span id="after-placeholder"><i class="fas fa-camera text-gray-300 text-xl"></i></span></div><input type="file" id="after-input" class="hidden" accept="image/*" onchange="uploadPhoto(this, 'after')"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                    <a href="https://www.myfreedetox.com/Worktolive" target="_blank" class="bg-green-600 p-6 rounded-3xl text-white block shadow-lg hover:scale-[1.01] transition-all"><h3 class="text-green-100 text-[10px] font-black uppercase italic tracking-widest text-center uppercase">Limited Offer</h3><p class="font-bold text-lg leading-tight uppercase">7-Day Detox: Get Your Free Bottle Here →</p></a>
                    <a href="https://www.shoplivegood.com/Worktolive" target="_blank" class="bg-blue-900 p-6 rounded-3xl text-white block shadow-lg hover:scale-[1.01] transition-all"><h3 class="text-blue-300 text-[10px] font-black uppercase italic tracking-widest text-center uppercase">Supplements</h3><p class="font-bold text-lg leading-tight uppercase tracking-tight">Access Member Wholesale Prices →</p></a>
                </div>

                <h2 class="text-sm font-black text-gray-800 uppercase italic tracking-widest text-center uppercase">Targeted Training Modules</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <button onclick="openMuscleGroup('Chest')" class="bg-white p-6 rounded-2xl border border-gray-100 text-center hover:border-blue-500 transition-all"><i class="fas fa-dumbbell text-blue-500 muscle-logo"></i><p class="font-black text-[10px] uppercase">Chest</p></button>
                    <button onclick="openMuscleGroup('Back')" class="bg-white p-6 rounded-2xl border border-gray-100 text-center hover:border-green-500 transition-all"><i class="fas fa-bars-staggered text-green-500 muscle-logo"></i><p class="font-black text-[10px] uppercase">Back</p></button>
                    <button onclick="openMuscleGroup('Legs')" class="bg-white p-6 rounded-2xl border border-gray-100 text-center hover:border-red-500 transition-all"><i class="fas fa-person-walking text-red-500 muscle-logo"></i><p class="font-black text-[10px] uppercase">Legs</p></button>
                    <button onclick="openMuscleGroup('Shoulders')" class="bg-white p-6 rounded-2xl border border-gray-100 text-center hover:border-orange-500 transition-all"><i class="fas fa-arrows-up-down-left-right text-orange-500 muscle-logo"></i><p class="font-black text-[10px] uppercase">Shoulders</p></button>
                    <button onclick="openMuscleGroup('Biceps')" class="bg-white p-6 rounded-2xl border border-gray-100 text-center hover:border-purple-500 transition-all"><i class="fas fa-hand-back-fist text-purple-500 muscle-logo"></i><p class="font-black text-[10px] uppercase">Biceps</p></button>
                    <button onclick="openMuscleGroup('Triceps')" class="bg-white p-6 rounded-2xl border border-gray-100 text-center hover:border-yellow-500 transition-all"><i class="fas fa-bolt-lightning text-yellow-500 muscle-logo"></i><p class="font-black text-[10px] uppercase">Triceps</p></button>
                </div>

                <section class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                    <h3 class="text-sm font-black mb-6 uppercase italic border-b pb-2 text-blue-900 tracking-widest uppercase">Update Latest Metrics</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="space-y-1"><label class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Weight (kg)</label><input type="number" id="inp-weight" class="bg-gray-50 w-full p-3 rounded-lg text-sm outline-none border" placeholder="0"></div>
                        <div class="space-y-1" id="height-container"><label class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Height (cm)</label><input type="number" id="inp-height" class="bg-gray-50 w-full p-3 rounded-lg text-sm outline-none border" placeholder="0"></div>
                        <div class="space-y-1"><label class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Chest (in)</label><input type="number" id="inp-chest" class="bg-gray-50 w-full p-3 rounded-lg text-sm outline-none border" placeholder="0"></div>
                        <div class="space-y-1"><label class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Waist (in)</label><input type="number" id="inp-waist" class="bg-gray-50 w-full p-3 rounded-lg text-sm outline-none border" placeholder="0"></div>
                        <div class="space-y-1"><label class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Upper Arm (in)</label><input type="number" id="inp-arm" class="bg-gray-50 w-full p-3 rounded-lg text-sm outline-none border" placeholder="0"></div>
                        <div class="space-y-1"><label class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Upper Leg (in)</label><input type="number" id="inp-uleg" class="bg-gray-50 w-full p-3 rounded-lg text-sm outline-none border" placeholder="0"></div>
                        <div class="space-y-1"><label class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Lower Leg (in)</label><input type="number" id="inp-lleg" class="bg-gray-50 w-full p-3 rounded-lg text-sm outline-none border" placeholder="0"></div>
                    </div>
                    <button onclick="updateStats()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl uppercase text-xs tracking-widest shadow-md hover:bg-blue-700 transition-all">Save My Data to Cloud</button>
                    <div class="mt-6 text-center border-t pt-4"><a href="https://www.myfreehealthreport.com/Worktolive" target="_blank" class="text-[11px] font-black text-blue-500 underline uppercase italic tracking-tighter">Download Your Free Health Assessment Here</a></div>
                </section>

                <div class="bg-blue-900 p-6 rounded-3xl text-white text-center shadow-xl">
                    <h3 class="text-sm font-black uppercase mb-1">Growth Initiative</h3>
                    <p class="text-[10px] text-blue-200 mb-4 uppercase tracking-widest">Share Garry's platform with your team</p>
                    <button onclick="shareInvite()" class="bg-white text-blue-900 w-full py-4 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-blue-50 transition-all">Share My Invite Link</button>
                </div>
            </div>

            <div id="workout-section" class="hidden space-y-6">
                <div class="flex items-center justify-between"><button onclick="showDashboard()" class="text-blue-600 font-bold text-sm uppercase tracking-tighter"><i class="fas fa-chevron-left mr-1"></i> Dashboard</button><h2 id="routine-title" class="text-xl font-black italic uppercase text-gray-900">TRAINING</h2></div>
                <div id="video-box" class="hidden"><div class="video-container"><iframe id="youtube-player" src="" allowfullscreen></iframe></div><button onclick="closeVideo()" class="mt-2 text-[10px] text-red-500 font-black uppercase tracking-widest text-center">Close Tutorial ×</button></div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 divide-y" id="exercise-container"></div>
                <button onclick="saveWorkoutSession()" class="w-full bg-green-600 text-white font-black py-5 rounded-xl mt-8 uppercase text-sm tracking-widest shadow-xl transition-all">Log Complete Session</button>
            </div>
        </main>
    </div>

    <script>
        const library = {
            'Chest': [{name:'Bench Press', v:'vcBig73ojpE'},{name:'Incline DB Press', v:'8iPEnn-ltC8'},{name:'Cable Fly', v:'W6vO7_S6pSg'},{name:'Pushups', v:'IODxDxX7oi4'}],
            'Back': [{name:'Deadlift', v:'op9kVnSso6Q'},{name:'Pull-Ups', v:'eGo4IYlbE5g'},{name:'Lat Pulldown', v:'CAwf7n6Luuc'},{name:'Seated Row', v:'GZbfZ033f74'}],
            'Legs': [{name:'Barbell Squat', v:'MVMNk0HiTMg'},{name:'Leg Press', v:'IZxyjW7MPJQ'},{name:'Lunges', v:'QOVaHwm-Q6U'},{name:'Calf Raises', v:'gwLzBJYoWlI'}],
            'Shoulders': [{name:'Military Press', v:'2yjwxtZ_Vkg'},{name:'Lateral Raise', v:'3VcKaXpzqRo'},{name:'Arnold Press', v:'6mvfH680S3k'}],
            'Biceps': [{name:'Barbell Curl', v:'LY1V6Cw_CoE'},{name:'Hammer Curl', v:'7jqi2qWAUzQ'},{name:'Preacher Curl', v:'fIWP-FRFNU0'}],
            'Triceps': [{name:'Pushdowns', v:'2-LAMcpzODU'},{name:'Skull Crushers', v:'d_KZx7p_DjI'},{name:'Dips', v:'yN6Q1UI_xkE'}]
        };

        window.openMuscleGroup = (group) => {
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('workout-section').classList.remove('hidden');
            document.getElementById('routine-title').innerText = group;
            const container = document.getElementById('exercise-container'); container.innerHTML = '';
            library[group].forEach(ex => {
                container.innerHTML += `<div class="py-5 exercise-row flex flex-col gap-3">
                    <div class="flex justify-between items-center"><span class="ex-name font-bold text-xs uppercase text-gray-700">${ex.name}</span>
                    <button onclick="playVideo('${ex.v}')" class="text-blue-600 text-[10px] font-black underline italic tracking-tighter uppercase">Watch Tutorial</button></div>
                    <div class="flex gap-2"><input type="number" class="wt-input w-full bg-gray-50 p-3 rounded-lg text-xs outline-none border" placeholder="Weight"><input type="number" class="rep-input w-full bg-gray-50 p-3 rounded-lg text-xs outline-none border" placeholder="Reps"></div></div>`;
            });
        };

        function renderTracker(start, latest) {
            const body = document.getElementById('progress-table-body'); body.innerHTML = '';
            ['weight', 'height', 'chest', 'waist', 'arm', 'uleg', 'lleg'].forEach(key => {
                const s = start[key] || 0; const l = latest[key] || 0; const diff = (l - s).toFixed(1);
                const color = diff < 0 ? 'text-green-500' : (diff > 0 ? 'text-red-500' : 'text-gray-400');
                const unit = key === 'weight' ? 'kg' : (key === 'height' ? 'cm' : 'in');
                body.innerHTML += `<tr class="border-b last:border-0 text-gray-800"><td class="py-3 font-bold uppercase text-[10px] tracking-tighter">${key}</td>
                    <td class="py-3 text-gray-400">${s}${unit}</td><td class="py-3 font-black">${l}${unit}</td>
                    <td class="py-3 text-right font-black ${color}">${diff > 0 ? '+':''}${diff}</td></tr>`;
                if(key === 'height' && s > 0) document.getElementById('height-container').classList.add('hidden');
            });
            if(latest.weight && latest.height) {
                const hM = latest.height / 100;
                document.getElementById('bmi-badge').innerText = "BMI: " + (latest.weight / (hM * hM)).toFixed(1);
            }
        }

        function loadPhotos(photos) {
            ['before', 'after'].forEach(type => {
                if(photos[type]) {
                    document.getElementById(`${type}-img`).src = photos[type];
                    document.getElementById(`${type}-img`).classList.remove('hidden');
                    document.getElementById(`${type}-placeholder`).classList.add('hidden');
                }
            });
        }

        window.playVideo = (id) => { document.getElementById('video-box').classList.remove('hidden'); document.getElementById('youtube-player').src = `https://www.youtube.com/embed/${id}?autoplay=1`; window.scrollTo({top: 0, behavior: 'smooth'}); };
        window.closeVideo = () => { document.getElementById('video-box').classList.add('hidden'); document.getElementById('youtube-player').src = ""; };
        window.showDashboard = () => { document.getElementById('workout-section').classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden'); };
        window.shareInvite = () => {
            const text = "Transform with the FITFLOW team! Use Coach Garry's free tracker: " + window.location.href;
            if (navigator.share) navigator.share({ title: 'FITFLOW Performance', text: text });
            else window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        };
    </script>
</body>
</html>